// app.js (Includes the combined logic from the previous response)

// ====================================================================
// *** PLACE THE ENTIRETY OF THE PREVIOUS JAVASCRIPT CODE HERE ***
// Including imports, constants, datum functions, and transaction functions.
// ====================================================================
import {
    Lucid,
    Blockfrost,
    Constr,
    Data
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

export const validatorCbor = {
    "type": "PlutusScriptV2",
    "description": "",
    "cborHex": "590f1f590f1c010000323232323233223232323232323232332232323322323232323232323232323233223232323232323232323223232323232322322323253353232323232533335004153353335530201200150162533533013350042200200113502f0011502e350052222220042153353253353335530221200135020502430250020011039103a35006222222002103913357389201196f6666696369616c20616c726561647920617070726f7665640003813263203a3357389201126e6f206f6666696369616c207369676e65640003b15335330123500322002350052222220051038133573892010f6f776e6572206d757374207369676e00037153355335330123500322002350052222220051038133573892010f6f776e6572206d757374207369676e0003715335533532325335333573466e24008d401c8888880040e40e84ccd5cd19b880013500722222200303a039103933019350062222220043500622222200235355001222222222222005223500222533350022100113263203e33573892112696e76616c69642074696d652072616e67650003f13263203e335738920112696e76616c69642074696d652072616e67650003f1038133573892013a63616e6e6f7420726566756e643a20646561646c696e65206e6f7420706173736564206f722073756666696369656e7420617070726f76616c730003715335333573466e20ccc054ccd54c06c48005406540a8cc04cd4014888888015400405c05cc05000c0dc0e040e04cd5ce24811e6d7573742073656e642066756c6c20616d6f756e7420746f206f776e65720003710371037153355335330123500322002350052222220051038133573892010f6f776e6572206d757374207369676e0003715335533532325335333573466e24008d401c8888880040e80e44ccd5cd19b880013500722222200303903a103933019350062222220043500622222200235355002222222222222005223500222533350022100113263203e33573892112696e76616c69642074696d652072616e67650003f13263203e335738920112696e76616c69642074696d652072616e67650003f1038133573892013963616e6e6f742072656c656173653a20696e73756666696369656e7420617070726f76616c73206f7220646561646c696e65207061737365640003715335333573466e20ccc054ccd54c06c48005406540a8cc04cd4014888888015400805c05cc05000c0dc0e040e04cd5ce24811e6d7573742073656e642066756c6c20616d6f756e7420746f206f776e6572000371037103713500222002135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40c00c4d5d0a80619a8180189aba1500b33503003235742a014666aa068eb940ccd5d0a804999aa81a3ae503335742a01066a06007c6ae85401cccd540d00fdd69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4125d69aba15002304a357426ae8940088c98c8138cd5ce02702782609aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a824bad35742a00460946ae84d5d1280111931902719ab9c04e04f04c135573ca00226ea8004d5d09aba2500223263204a33573809409609026aae7940044dd50009aba1500533503075c6ae854010ccd540d00ec8004d5d0a801999aa81a3ae200135742a004607a6ae84d5d1280111931902319ab9c046047044135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008605a6ae84d5d1280211931901c19ab9c0380390363333573466e1d4015200621222200223333573466e1d4019200421222200123333573466e1d401d200221222200423333573466e1d4021200021222200323263203a33573807407607006e06c06a6666ae68cdc39aab9d500b480008cccccc88888848cccccc00401c01801401000c008dd69aba1500b375c6ae854028cd4081d71aba15009375a6ae854020cd4081d71aba15007375a6ae84d5d1280391931901b19ab9c036037034103616135573ca00226ea80044d55ce9baa001135744a00226ae8940044d5d1280089aba25001135573ca00226ea800488d40088888888888894cd4ccd54c07048005404894cd4ccd5cd19b8f00e00103503413502b0011502a00421035103322350012222222222223335530161200122350022222350042233500225335333573466e3c05c0040f00ec4cd40b401802040208021409402894cd4d400488d4008888888888888cccd4034940a4940a4940a48ccd54c0704800540488d4004894cd54cd4ccd5cd19b8f350022200235004220020370361333573466e1cd400888004d4010880040dc0d840d84d40b400c540b003484ccc00cd4d400488004888800c0140144c98c809ccd5ce2491473637269707420696e707574206d697373696e6700028222323230010053200135502c223350014800088d4008894cd4ccd5cd19b8f00200902d02c13007001130060033200135502b223350014800088d4008894cd4ccd5cd19b8f00200702c02b100113006003133500b225335002210031001501748810022333355300a1200133500b22230033002001200122533533355300c120013500a500e300f00200413370000290010800800a400024466aa60102400246a0024466aa02e00466aa60162400246a0024466aa034004666a00246605890000009119816801000919816000a400000266aa60102400246a0024466aa02e004666a002466aa60182400246a0024466aa0360046aa01a00200244666aaa010022004002466aa60182400246a0024466aa0360046aa018002002666aaa006018004002222444666aa600824002a02466aa60102400246a0024466aa02e0046aa012002666aa600824002446a00444a66a666aa601a240026a016a01e46a002446601400400a00c2006266a02c008006a02600266aa60102400246a002446466aa030006600200a640026aa05244a66a00226aa0140064426a00444a66a6601800401022444660040140082600c006004640026aa0444422444a66a00220044426600a004666aa600e2400200a00800222424446006008224244460020082466a00844666a006440040040026a00244002640026aa03c442244a66a0022a01e44266a020600800466aa600c24002008002640026aa03a4422444a66a00226a00644002442666a00a440046008004666aa600e2400200a00800224424660020060042246600244a66a0042032200202c44666ae68cdc780100080b80b0919118011bac0013200135501a2233335573e0024a014466a01260086ae84008c00cd5d100100d119191999ab9a3370e6aae7540092000233221233001003002300f35742a004600a6ae84d5d1280111931900c99ab9c01901a017135573ca00226ea80048c8c8c8c8cccd5cd19b8735573aa00890001199991110919998008028020018011919191999ab9a3370e6aae7540092000233221233001003002301835742a00466a02002e6ae84d5d1280111931900f19ab9c01e01f01c135573ca00226ea8004d5d0a802199aa8043ae500735742a0066464646666ae68cdc3a800a4008464244460040086ae84d55cf280191999ab9a3370ea0049001119091118008021bae357426aae7940108cccd5cd19b875003480008488800c8c98c8080cd5ce01001080f00e80e09aab9d5001137540026ae854008cd4031d71aba135744a004464c6403466ae7006806c0604d5d1280089aba25001135573ca00226ea80044cd54005d73ad112232230023756002640026aa02e44646666aae7c008940208cd401ccd54024c018d55cea80118029aab9e500230043574400603026ae840044488008488488cc00401000c448848cc00400c008488c8c8cccd5cd19b875001480008d401cc014d5d09aab9e500323333573466e1d400920022500723263201433573802802a02402226aae7540044dd50008909118010018891000919191999ab9a3370ea002900311909111180200298039aba135573ca00646666ae68cdc3a8012400846424444600400a60126ae84d55cf280211999ab9a3370ea006900111909111180080298039aba135573ca00a46666ae68cdc3a8022400046424444600600a6eb8d5d09aab9e500623263201233573802402602001e01c01a26aae7540044dd5000919191999ab9a3370e6aae7540092000233221233001003002300535742a0046eb4d5d09aba2500223263200e33573801c01e01826aae7940044dd50009191999ab9a3370e6aae75400520002375c6ae84d55cf280111931900619ab9c00c00d00a13754002464646464646666ae68cdc3a800a401842444444400646666ae68cdc3a8012401442444444400846666ae68cdc3a801a40104664424444444660020120106eb8d5d0a8029bad357426ae8940148cccd5cd19b875004480188cc8848888888cc008024020dd71aba15007375c6ae84d5d1280391999ab9a3370ea00a900211991091111111980300480418061aba15009375c6ae84d5d1280491999ab9a3370ea00c900111909111111180380418069aba135573ca01646666ae68cdc3a803a400046424444444600a010601c6ae84d55cf280611931900a99ab9c01501601301201101000f00e00d135573aa00826aae79400c4d55cf280109aab9e5001137540024646464646666ae68cdc3a800a4004466644424466600200a0080066eb4d5d0a8021bad35742a0066eb4d5d09aba2500323333573466e1d4009200023212230020033008357426aae7940188c98c8038cd5ce00700780600589aab9d5003135744a00226aae7940044dd5000919191999ab9a3370ea002900111909118008019bae357426aae79400c8cccd5cd19b875002480008c8488c00800cdd71aba135573ca008464c6401666ae7002c0300240204d55cea80089baa00112232323333573466e1d400520042122200123333573466e1d40092002232122230030043006357426aae7940108cccd5cd19b87500348000848880088c98c8030cd5ce00600680500480409aab9d5001137540024646666ae68cdc3a800a4004400a46666ae68cdc3a80124000400a464c6401066ae700200240180144d55ce9baa0011220021220014992410350543100120012233700004002224646002002446600660040040021"
}

export const validator = {
    type: "PlutusV2",
    script: validatorCbor.cborHex
}

// --- GLOBAL STATE ---
let lucid;

const depositBtn = document.getElementById("depositBtn")
const approveBtn = document.getElementById("approveBtn")
const releaseBtn = document.getElementById("releaseBtn")
const refundBtn  = document.getElementById("refundBtn")

// --- CONSTANTS/FUNCTIONS (Assume pasted here from the previous response) ---
// const SCRIPT_ADDRESS = "addr_test1qr...your...script...address";
// const createStakeTransaction = async (lucid, lovelaceAmount) => { ... };
// const claimAndUnstake = async (lucid, utxo) => { ... };


// ====================================================================
// 6. WALLET CONNECTION AND INITIALIZATION
// ====================================================================

/**
 * Initializes Lucid and connects to a browser wallet.
 */
async function connectWallet() {

    try {
        // 1. Initialize Lucid instance
        // You MUST configure this for your target network (Mainnet, Preprod, etc.)
        lucid = await Lucid.new(

            new Blockfrost(
                "https://cardano-preprod.blockfrost.io/api/v0",
                "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip"
            ),
            "Preprod"


        );

        // 2. Request connection from the user's wallet (e.g., Nami)
        const api = await window.cardano.lace.enable();
        lucid.selectWallet(api);

        const walletAddress = await lucid.wallet.address();


        const validatorAddress = lucid.utils.validatorToAddress(validator)


        return { lucid, walletAddress, validatorAddress }
        // In a real app, you would now call a function to fetch UTxOs.
        // fetchStakedUTxOs(walletAddress);

    } catch (error) {
        console.error("Wallet connection failed:", error);

    }
}
depositBtn.addEventListener('click', async function () {
    const { lucid, walletAddress, validatorAddress } = await connectWallet()
    const depositAmount = BigInt(document.getElementById("depositAmt").value) * 1_000_000n
    const signerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash

    let datumObj = {
        fdTotalAmount: 5_000_000n,
        fdOwner: signerPkh
        , fdOfficials: [signerPkh]
        , fdRequiredApprovals: 1n
        , fdApprovals: []
        , fdDeadline: BigInt(new Date().getTime())
    }
    const datum = new Constr(0, [
        datumObj.fdTotalAmount,
        datumObj.fdOwner,
        datumObj.fdOfficials,
        datumObj.fdRequiredApprovals,
        datumObj.fdApprovals,
        datumObj.fdDeadline
    ])

    try {
        console.log({ depositAmount, signerPkh });
        const tx = await lucid
            .newTx()
            .payToContract(
                validatorAddress,
                { inline: Data.to(datum) },
                { lovelace: depositAmount }
            )
            .complete()
        const txSigned = await tx.sign().complete()
        const txHash = await txSigned.submit()
        console.log(` Tx Hash: ${txHash}`);
    } catch (e) {
        console.error(e);
    }

})

// ====================================================================
// 7. EVENT LISTENERS
// ====================================================================


approveBtn.addEventListener('click', async () => {
    const { lucid, walletAddress, validatorAddress } = await connectWallet()

    const signerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash

    const scriptutxos = await lucid.utxosAt(validatorAddress)
    let goodUtxo = undefined
    if (scriptutxos === undefined) {
        alert("Deposit first")
        return
    }
    for (let utxo of scriptutxos) {

        const datum = Data.from(utxo.datum)
        let [fdTotalAmount,
            fdOwner
            , fdOfficials
            , fdRequiredApprovals
            , fdApprovals
            , fdDeadline] = datum.fields

        if (fdOfficials.includes(signerPkh)) {
            goodUtxo = utxo
            break
        }
    }
    if (goodUtxo === undefined) {
        alert("you're not in the officials. Deposit")
        return
    }
    const datum = Data.from(goodUtxo.datum)
    console.log({ datum })
    const [fdTotalAmount,
        fdOwner
        , fdOfficials
        , fdRequiredApprovals
        , fdApprovals
        , fdDeadline] = datum.fields
    console.log({ fdApprovals });
    fdApprovals.unshift(signerPkh)
    const newDatum = new Constr(0, [
        fdTotalAmount,
        fdOwner
        , fdOfficials
        , fdRequiredApprovals
        , fdApprovals
        , fdDeadline
    ])
    console.log({ fdApprovals });

const releaseBtn = document.getElementById("releaseBtn")

releaseBtn.addEventListener("click", async () => {
    const { lucid, walletAddress, validatorAddress } = await connectWallet()

    const signerPkh =
        lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash

    const scriptUtxos = await lucid.utxosAt(validatorAddress)
    if (scriptUtxos.length === 0) {
        alert("No funds locked")
        return
    }

    // pick the first valid UTxO (improve later)
    const utxo = scriptUtxos[0]
    const datum = Data.from(utxo.datum)
    const [
        fdTotalAmount,
        fdOwner,
        fdOfficials,
        fdRequiredApprovals,
        fdApprovals,
        fdDeadline
    ] = datum.fields

    if (fdOwner !== signerPkh) {
        alert("Only owner can release")
        return
    }

    try {
        const tx = await lucid
            .newTx()
            .collectFrom([utxo], Data.to(new Constr(2, []))) // Release
            .addSignerKey(signerPkh)
            .attachSpendingValidator(validator)
            .payToAddress(
                lucid.utils.credentialToAddress({
                    type: "Key",
                    hash: signerPkh
                }),
                utxo.assets
            )
            .validTo(Number(fdDeadline)) // MUST be before deadline
            .complete()

        const signed = await tx.sign().complete()
        const txHash = await signed.submit()
        console.log("Release TX:", txHash)
    } catch (e) {
        console.error("Release failed:", e)
    }
})

const refundBtn = document.getElementById("refundBtn")

refundBtn.addEventListener("click", async () => {
    const { lucid, walletAddress, validatorAddress } = await connectWallet()

    const signerPkh =
        lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash

    const scriptUtxos = await lucid.utxosAt(validatorAddress)
    if (scriptUtxos.length === 0) {
        alert("No funds locked")
        return
    }

    const utxo = scriptUtxos[0]
    const datum = Data.from(utxo.datum)
    const [
        fdTotalAmount,
        fdOwner,
        fdOfficials,
        fdRequiredApprovals,
        fdApprovals,
        fdDeadline
    ] = datum.fields

    if (fdOwner !== signerPkh) {
        alert("Only owner can refund")
        return
    }

    try {
        const tx = await lucid
            .newTx()
            .collectFrom([utxo], Data.to(new Constr(3, []))) // Refund
            .addSignerKey(signerPkh)
            .attachSpendingValidator(validator)
            .payToAddress(
                lucid.utils.credentialToAddress({
                    type: "Key",
                    hash: signerPkh
                }),
                utxo.assets
            )
            .validFrom(Number(fdDeadline) + 1) // MUST be after deadline
            .complete()

        const signed = await tx.sign().complete()
        const txHash = await signed.submit()
        console.log("Refund TX:", txHash)
    } catch (e) {
        console.error("Refund failed:", e)
    }
})

    

    // let goodScriptUtxo = undefined
    // for (let utxo of scriptutxos) {
    //     let datum = Data.from(utxo.datum)
    //     console.log({ datum })
    //     if (datum.fields[1] === signerPkh) {
    //         goodScriptUtxo = utxo
    //         break
    //     }

    // }
    // console.log({ goodScriptUtxo })
    // if (goodScriptUtxo === undefined) {
    //     alert("Lock funds first")
    //     return
    // }
    const userUtxos = await lucid.wallet.getUtxos()
    const redeemer = new Constr(1, [])
    try {
        // Since we are simulating, the claim transaction will likely fail 
        // unless a matching UTxO and correct time are actually available on the testnet.
        const tx = await lucid
            .newTx()
            .collectFrom(userUtxos)
            .collectFrom([goodUtxo], Data.to(redeemer))
            .payToContract(
                validatorAddress,
                { inline: Data.to(newDatum) },
                { lovelace: goodUtxo.assets.lovelace }
            )
            .addSignerKey(signerPkh)
            .attachSpendingValidator(validator)
            .complete()

        const txSigned = await tx.sign().complete()
        const txHash = await txSigned.submit()
        console.log({ txHash });
    } catch (e) {

        console.error(e);
    }
});

// // ====================================================================
// // 8. DATA FETCHING (Concept for a Real dApp)
// // ====================================================================

// /**
//  * Conceptually, this function would query the blockchain for UTxOs at the script address.
//  * It would then filter and decode the Datum of each UTxO to determine if it belongs
//  * to the connected wallet's PubKeyHash.
//  * @param {string} stakerAddress - The connected wallet's address.
//  */
// // async function fetchStakedUTxOs(stakerAddress) {
// //     // 1. Get all UTxOs at the script address
// //     // const scriptUtxos = await lucid.utxosAt(SCRIPT_ADDRESS);

// //     // 2. Filter and Decode
// //     // This is the hard part requiring CBOR decoding and datum parsing.
// //     // const myStakes = scriptUtxos.filter(utxo => {
// //     //     // Decode utxo.datum -> get sdStaker -> check if it matches stakerAddress hash
// //     // });

// //     // 3. Populate Selector
// //     // utxoSelector.innerHTML = '<option value="" disabled selected>Select a Staked UTxO</option>';
// //     // myStakes.forEach((utxo, index) => {
// //     //     const option = document.createElement('option');
// //     //     option.value = index;
// //     //     option.textContent = `UTxO #${index} (${utxo.assets.lovelace / 1000000n} ADA)`;
// //     //     utxoSelector.appendChild(option);
// //     // });
// // }
